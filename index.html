<!DOCTYPE html>
<html lang="en">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Cozy Keep - Guild Housing</title>
        <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
        <style>
                    :root {
                                    --primary: #4a6741;
                                    --secondary: #8fbc8f;
                                    --accent: #ffd700;
                                    --bg-dark: #0a0a12;
                                    --bg-medium: #131317;
                                    --bg-card: #1a1a2e;
                                    --text: #e0e0e0;
                                    --glow: rgba(74, 158, 255, 0.5);
                                    --success: #4caf50;
                                    --warning: #ff9800;
                                    --danger: #f44336;
                    }
                    .horde { --primary: #8b0000; --accent: #ff6600; --glow: rgba(255, 74, 74, 0.5); }
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: 'Open Sans', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; overflow-x: hidden; }
                    .bg-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at 50% 0%, rgba(74, 158, 255, 0.15) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 40%); z-index: 0; }
                    .horde .bg-gradient { background: radial-gradient(ellipse at 50% 0%, rgba(255, 140, 0, 0.15) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(255, 0, 0, 0.1) 0%, transparent 40%); }
                    header { position: relative; z-index: 10; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(10,10,18,0.9); flex-wrap: wrap; gap: 1rem; }
                    .logo { font-family: 'Cinzel', serif; font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; }
                    .header-nav { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
                    .nav-btn { padding: 10px 20px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
                    .nav-btn:hover { background: rgba(255,255,255,0.15); }
                    .nav-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
                    .nav-btn.admin-btn { background: linear-gradient(135deg, #6b218b, #f533ea); border-color: #9333ea; }
                    .faction-switch { display: flex; }
                    .faction-btn { padding: 10px 20px; border: 2px solid transparent; border-radius: 8px; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease; }
                    .faction-btn.alliance { background: linear-gradient(135deg, #1a4a6e, #2a82b8); border-color: #4a9eff; color: #fff; }
                    .faction-btn.horde-btn { background: linear-gradient(135deg, #6e1a1a, #b82a2a); border-color: #ff4a4a; color: #fff; }
                    .faction-btnhover, .faction-btn.active { transform: scale(1.05); box-shadow: 0 0 20px var(--glow); }
                    main { position: relative; z-index: 10; max-width: 1400px; margin: 0 auto; padding: 30px; }
                    .view-container { display: none; }
                    .view-container.active { display: block; }
                    .subdivision-tabs { display: flex; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center; }
                    .subdivision-tab { padding: 12px 25px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
                    .subdivision-tabhover { border-color: var(--primary); }
                    .subdivision-tab.active { background: linear-gradient(135deg, var(--primary), #4a6e7f); border-color: var(--primary); box-shadow: 0 0 15px var(--glow); }
                    .hero { text-align: center; padding: 15px 0; }
                    .hero h1 { font-family: 'Cinzel', serif; font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(135deg, var(--text), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                    .hero p { color: rgba(255,255,255,0.6); font-size: 1rem; }
                    .neighborhood-badge { display: inline-block; padding: 5px 25px; margin-top: 12px; background: var(--bg-card); border: 1px solid var(--primary); border-radius: 25px; font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--accent); box-shadow: 0 0 20px var(--glow); }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 25px 0; }
                    .stat-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 18px; text-align: center; transition: all 0.3s ease; }
                    .stat-cardhover { transform: translateY(-3px); border-color: var(--primary); }
                    .stat-icon { font-size: 1.8rem; margin-bottom: 8px; }
                    .stat-value { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; color: var(--accent); }
                    .stat-label { font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; }
                    .plot-map-container { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin: 25px 0; }
                    .section-title { font-family: 'Cinzel', serif; font-size: 1.5rem; margin-bottom: 18px; display: flex; align-items: center; gap: 10px; }
                    .plot-grid { display: grid; grid-template-columns: repeat(11, 1fr); gap: 8px; }
                    .plot { aspect-ratio: 1; background: rgba(30, 30, 50, 0.8); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem; padding: 3px; }
                    .plot.empty { border-style: dashed; opacity: 0.5; }
                    .plot.unclaimed { border-color: var(--accent); border-style: dashed; }
                    .plot.claimed { background: linear-gradient(135deg, rgba(74, 158, 255, 0.2), rgba(30, 30, 50, 0.8)); border-color: var(--primary); }
                    .plot.pending { border-color: var(--warning); background: linear-gradient(135deg, rgba(255, 170, 0, 0.3), rgba(30, 30, 50, 0.8)); animation: pending-pulse 2s ease-in-out infinite; }
                    @keyframes pending-pulse { 0%, 100% { box-shadow: 0 0 5px rgba(255, 170, 0, 0.3); } 50% { box-shadow: 0 0 15px rgba(255, 170, 0, 0.6); } }
                    .plot-number { font-weight: 600; color: rgba(255,255,255,0.4); font-size: 0.65rem; }
                    .plot-owner { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 95%; font-size: 0.55rem; }
                    .member-list-container { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin: 25px 0; overflow-x: auto; }
                    .member-table { width: 100%; border-collapse: collapse; }
                    .member-table th { padding: 15px 12px; text-align: left; font-family: 'Cinzel', serif; font-size: 0.85rem; color: var(--primary); border-bottom: 2px solid var(--primary); }
                    .member-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
                    .member-table tr:hover td { background: rgba(74, 158, 255, 0.1); }
                    .request-section { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin: 25px 0; }
                    .form-row { display: flex; gap: 12px; margin-top: 18px; flex-wrap: wrap; }
                    .form-input, .form-select { flex: 1; min-width: 180px; padding: 12px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 0.95rem; }
                    .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 10px var(--glow); }
                    .btn-primary { padding: 12px 30px; background: linear-gradient(135deg, var(--primary), #5a8051); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
                    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--glow); }
                    .btn-danger { background: linear-gradient(135deg, #c0392b, #e74c3c); }
                    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
                    .admin-view { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin: 25px 0; }
                    .admin-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
                    .pending-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
                    .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid var(--warning); flex-wrap: wrap; gap: 10px; }
                    .pending-actions { display: flex; gap: 8px; }
                    .btn-approve { padding: 8px 16px; background: var(--success); border: none; border-radius: 6px; color: white; cursor: pointer; }
                    .btn-deny { padding: 8px 16px; background: var(--danger); border: none; border-radius: 6px; color: white; cursor: pointer; }
                    .login-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
                    .login-modal.active { display: flex; }
                    .login-box { background: var(--bg-card); padding: 40px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); text-align: center; max-width: 400px; width: 90%; }
                    .login-box h2 { font-family: 'Cinzel', serif; margin-bottom: 20px; color: var(--accent); }
                    .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); }
                    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; z-index: 2000; animation: slideIn 0.3s ease; }
                    .toast.success { background: var(--success); }
                    .toast.error { background: var(--danger); }
                    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                    .public-view .hero h1::after { content: " - Home"; font-size: 1.2rem; }
                    .sync-status { display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(0,0,0,0.3); border-radius: 20px; font-size: 0.8rem; }
                    .sync-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
                    .sync-indicator.syncing { background: var(--warning); animation: pulse 1s infinite; }
                    .sync-indicator.error { background: var(--danger); }
                    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
                    @media (max-width: 768px) {
                                    .plot-grid { grid-template-columns: repeat(6, 1fr); }
                                    .header { padding: 1rem; }
                                    .hero h1 { font-size: 1.8rem; }
                    }
                </style>
    </head>
    <body>
            <div class="bg-gradient"></div>div>
            <header>
                        <div class="logo">The Cozy Keep</div>div>
                        <div class="header-nav">
                                        <button class="nav-btn active" id="nav-public" onclick="showView('public')">Home</button>button>
                                        <button class="nav-btn" id="nav-admin" onclick="showAdminLogin()">Officer Dashboard</button>button>
                                        <div class="faction-switch">
                                                            <button class="faction-btn alliance active" onclick="setFaction('alliance')">Alliance</button>button>
                                                            <button class="faction-btn horde-btn" onclick="setFaction('horde')">Horde</button>button>
                                        </div>div>
                                        <div class="sync-status">
                                                            <div class="sync-indicator" id="sync-indicator"></div>div>
                                                            <span id="sync-text">Synced</span>span>
                                        </div>div>
                        </div>div>
            </header>
            <main>
                        <div class="view-container active" id="public-view">
                                        <div class="subdivision-tabs" id="public-subdivision-tabs"></div>div>
                                        <div class="hero">
                                                            <h1 id="subdivision-title">Guild Housing</h1>h1>
                                                            <p>Manage your guild neighborhood plots</p>
                                                        <div class="neighborhood-badge" id="neighborhood-badge">üè∞ Alliance ¬∑ <span id="current-faction-text">Sargeras</span>span></div>div>
                                        </div>div>
                                    <div class="stats-grid" id="stats-grid">
                                                    <div class="stat-card"><div class="stat-icon">üè†</div>div><div class="stat-value" id="stat-total">0</div>div><div class="stat-label">Total Plots</div>div></div>div>
                                                    <div class="stat-card"><div class="stat-icon">‚ú®</div>div><div class="stat-value" id="stat-available">0</div>div><div class="stat-label">Available</div>div></div>div>
                                                    <div class="stat-card"><div class="stat-icon">üë•</div>div><div class="stat-value" id="stat-claimed">0</div>div><div class="stat-label">Claimed</div>div></div>div>
                                                    <div class="stat-card"><div class="stat-icon">‚è≥</div>div><div class="stat-value" id="stat-pending">0</div>div><div class="stat-label">Pending</div>div></div>div>
                                    </div>div>
                                    <div class="plot-map-container">
                                                    <h2 class="section-title">üìç Plot Map</h2>h2>
                                                    <div class="plot-grid" id="plot-grid"></div>div>
                                    </div>div>
                                    <div class="member-list-container">
                                                    <h2 class="section-title">üìã Plot Assignments</h2>h2>
                                                    <table class="member-table">
                                                                        <thead><tr><th>Plot</th><th>Owner</th><th>Status</th></tr></thead>
                                                                        <tbody id="member-list"></tbody>tbody>
                                                    </table>table>
                                    </div>div>
                                    <div class="request-section">
                                                    <h2 class="section-title">üìù Request a Plot</h2>h2>
                                                    <p>Submit your character name to request an available plot.</p>
                                                    <div class="form-row">
                                                                        <input type="text" class="form-input" id="request-name" placeholder="Character Name">
                                                                        <select class="form-select" id="request-plot"></select>select>
                                                                        <button class="btn-primary" onclick="submitRequest()">Submit Request</button>button>
                                                    </div>div>
                                    </div>
                        </div>div>
                    <div class="view-container" id="admin-view">
                                <div class="subdivision-tabs" id="admin-subdivision-tabs"></div>div>
                                <div class="admin-view">
                                                <div class="admin-section">
                                                                    <h2 class="section-title">‚è≥ Pending Requests</h2>h2>
                                                                    <div class="pending-list" id="pending-list"></div>div>
                                                </div>div>
                                                <div class="admin-section">
                                                                    <h2 class="section-title">‚ûï Quick Assign Plot</h2>h2>
                                                                    <div class="form-row">
                                                                                            <input type="text" class="form-input" id="assign-name" placeholder="Character Name">
                                                                                            <select class="form-select" id="assign-plot"></select>select>
                                                                                            <button class="btn-primary" onclick="quickAssign()">Assign</button>button>
                                                                    </div>div>
                                                </div>div>
                                                <div class="admin-section">
                                                                    <h2 class="section-title">üóëÔ∏è Remove Assignment</h2>h2>
                                                                    <div class="form-row">
                                                                                            <select class="form-select" id="remove-plot"></select>select>
                                                                                            <button class="btn-primary btn-danger" onclick="removePlot()">Remove</button>button>
                                                                    </div>div>
                                                </div>div>
                                                <div class="admin-section">
                                                                    <h2 class="section-title">üîß Subdivision Settings</h2>h2>
                                                                    <div class="form-row">
                                                                                            <input type="text" class="form-input" id="new-subdivision-name" placeholder="New Subdivision Name">
                                                                                            <input type="number" class="form-input" id="new-subdivision-plots" placeholder="Number of Plots" min="1" max="200">
                                                                                            <button class="btn-primary" onclick="addSubdivision()">Add Subdivision</button>button>
                                                                    </div>div>
                                                </div>div>
                                                <button class="btn-primary btn-warning" style="margin-top: 20px;" onclick="logout()">Logout</button>button>
                                </div>div>
                    </div>div>
            </main>
        <div class="login-modal" id="login-modal">
                <div class="login-box">
                            <h2>üîê Officer Login</h2>
                            <input type="password" id="admin-password" placeholder="Enter Password" onkeypress="if(event.key==='Enter') attemptLogin()">
                            <button class="btn-primary" onclick="attemptLogin()">Login</button>button>
                            <p style="margin-top: 15px; font-size: 0.8rem; opacity: 0.6;">Officers only</p>
                </div>div>
        </div>div>
        <script>
                    const API_BASE = 'https://statuesque-meringue-56f222.netlify.app/.netlify/functions';
                    let appData = {
                                    alliance: { subdivisions: [{ id: 1, name: 'Stormwind Heights', plots: 55 }], plots: {} },
                                    horde: { subdivisions: [{ id: 1, name: 'Orgrimmar Plaza', plots: 55 }], plots: {} }
                    };
                    let currentFaction = 'alliance';
                    let currentSubdivision = 1;
                    let isAdmin = false;
                    let isSyncing = false;

                    async function loadData() {
                                    updateSyncStatus('syncing');
                                    try {
                                                        const response = await fetch(`${API_BASE}/data-sync?action=load`);
                                                        if (response.ok) {
                                                                                const serverData = await response.json();
                                                                                if (serverData && serverData.alliance) {
                                                                                                            appData = serverData;
                                                                                                            localStorage.setItem('cozyKeepData', JSON.stringify(appData));
                                                                                    }
                                                        }
                                                        updateSyncStatus('synced');
                                    } catch (error) {
                                                        console.error('Failed to load from server, using local data:', error);
                                                        const localData = localStorage.getItem('cozyKeepData');
                                                        if (localData) {
                                                                                try { appData = JSON.parse(localData); } catch(e) {}
                                                        }
                                                        updateSyncStatus('error');
                                    }
                                    renderAll();
                    }

                    async function saveData() {
                                    localStorage.setItem('cozyKeepData', JSON.stringify(appData));
                                    updateSyncStatus('syncing');
                                    try {
                                                        const response = await fetch(`${API_BASE}/data-sync`, {
                                                                                method: 'POST',
                                                                                headers: { 'Content-Type': 'application/json' },
                                                                                body: JSON.stringify({ action: 'save', data: appData })
                                                        });
                                                        if (response.ok) {
                                                                                updateSyncStatus('synced');
                                                        } else {
                                                                                updateSyncStatus('error');
                                                        }
                                    } catch (error) {
                                                        console.error('Failed to save to server:', error);
                                                        updateSyncStatus('error');
                                    }
                    }

                    function updateSyncStatus(status) {
                                    const indicator = document.getElementById('sync-indicator');
                                    const text = document.getElementById('sync-text');
                                    indicator.className = 'sync-indicator';
                                    if (status === 'syncing') {
                                                        indicator.classList.add('syncing');
                                                        text.textContent = 'Syncing...';
                                    } else if (status === 'error') {
                                                        indicator.classList.add('error');
                                                        text.textContent = 'Offline';
                                    } else {
                                                        text.textContent = 'Synced';
                                    }
                    }

                    function getNeighborhood() { return appData[currentFaction]; }
                    function getSubdivision(id) { return getNeighborhood().subdivisions.find(s => s.id === id) || getNeighborhood().subdivisions[0]; }
                    function getEnabledSubdivisions() { return getNeighborhood().subdivisions.filter(s => s.enabled !== false); }
                    function getPlots() { return appData[currentFaction].plots || {}; }

                    function showView(view) {
                                    document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
                                    if (view === 'admin' && isAdmin) {
                                                        document.getElementById('admin-view').classList.add('active');
                                                        document.getElementById('nav-admin').classList.add('active');
                                                        document.getElementById('nav-public').classList.remove('active');
                                                        renderAdminView();
                                    } else {
                                                        document.getElementById('public-view').classList.add('active');
                                                        document.getElementById('nav-public').classList.add('active');
                                                        document.getElementById('nav-admin').classList.remove('active');
                                                        renderPublicView();
                                    }
                    }

                    function showAdminLogin() {
                                    if (isAdmin) { showView('admin'); return; }
                                    document.getElementById('login-modal').classList.add('active');
                                    document.getElementById('admin-password').focus();
                    }

                    function attemptLogin() {
                                    if (document.getElementById('admin-password').value === 'deathology87') {
                                                        isAdmin = true;
                                                        closeLoginModal();
                                                        showView('admin');
                                                        showToast('Welcome back, officer!', 'success');
                                    } else {
                                                        showToast('Invalid password', 'error');
                                    }
                    }

                    function closeLoginModal() { document.getElementById('login-modal').classList.remove('active'); }
                    function logout() { isAdmin = false; showView('public'); showToast('Logged out', 'success'); }

                    function setFaction(faction) {
                                    currentFaction = faction;
                                    currentSubdivision = getEnabledSubdivisions()[0]?.id || 1;
                                    document.body.classList.toggle('horde', faction === 'horde');
                                    document.querySelectorAll('.faction-btn').forEach(btn => btn.classList.remove('active'));
                                    document.querySelector(`.faction-btn.${faction === 'horde' ? 'horde-btn' : 'alliance'}`).classList.add('active');
                                    document.getElementById('current-faction-text').textContent = faction === 'horde' ? 'Area 52' : 'Sargeras';
                                    document.getElementById('neighborhood-badge').innerHTML = faction === 'horde' 
                                        ? 'üî• Horde ¬∑ <span id="current-faction-text">Area 52</span>' 
                                                        : 'üè∞ Alliance ¬∑ <span id="current-faction-text">Sargeras</span>';
                                    renderAll();
                    }

                    function renderSubdivisionTabs() {
                                    const enabled = getEnabledSubdivisions();
                                    let html = '';
                                    if (!enabled.find(s => s.id === currentSubdivision) && enabled.length > 0) {
                                                        currentSubdivision = enabled[0].id;
                                    }
                                    const plotsData = getPlots();
                                    enabled.forEach(sub => {
                                                        const claimCount = Object.values(plotsData).filter(p => p.subdivisionId === sub.id && p.status === 'claimed').length;
                                                        html += `<button class="subdivision-tab ${sub.id === currentSubdivision ? 'active' : ''}" onclick="selectSubdivision(${sub.id})">${sub.name} <span style="opacity: 0.6; font-size: 0.8em;">(${claimCount}/${sub.plots})</span></button>`;
                                    });
                                    document.getElementById('public-subdivision-tabs').innerHTML = html;
                                    document.getElementById('admin-subdivision-tabs').innerHTML = html;
                    }

                    function selectSubdivision(id) { currentSubdivision = id; renderAll(); }

                    function renderPublicView() {
                                    const subdivision = getSubdivision(currentSubdivision);
                                    if (!subdivision) return;
                                    const plotsData = getPlots();
                                    document.getElementById('subdivision-title').textContent = subdivision.name;
                                    const plots = subdivision.plots || 55;
                                    const claimed = Object.values(plotsData).filter(p => p.subdivisionId === currentSubdivision && p.status === 'claimed').length;
                                    const pending = Object.values(plotsData).filter(p => p.subdivisionId === currentSubdivision && p.status === 'pending').length;
                                    document.getElementById('stat-total').textContent = plots;
                                    document.getElementById('stat-available').textContent = plots - claimed - pending;
                                    document.getElementById('stat-claimed').textContent = claimed;
                                    document.getElementById('stat-pending').textContent = pending;

                                    let gridHtml = '';
                                    for (let i = 1; i <= plots; i++) {
                                                        const plotKey = `${currentFaction}-${currentSubdivision}-${i}`;
                                                        const plot = plotsData[plotKey];
                                                        let statusClass = 'unclaimed';
                                                        let ownerText = '';
                                                        if (plot) {
                                                                                statusClass = plot.status;
                                                                                ownerText = plot.owner || '';
                                                        }
                                                        gridHtml += `<div class="plot ${statusClass}" title="Plot ${i}${ownerText ? ': ' + ownerText : ''}"><span class="plot-number">#${i}</span><span class="plot-owner">${ownerText}</span></div>`;
                                    }
                                    document.getElementById('plot-grid').innerHTML = gridHtml;

                                    let listHtml = '';
                                    Object.entries(plotsData).filter(([key, p]) => key.startsWith(`${currentFaction}-${currentSubdivision}-`)).sort((a, b) => {
                                                        const numA = parseInt(a[0].split('-')[2]);
                                                        const numB = parseInt(b[0].split('-')[2]);
                                                        return numA - numB;
                                    }).forEach(([key, p]) => {
                                                        const plotNum = key.split('-')[2];
                                                        listHtml += `<tr><td>#${plotNum}</td><td>${p.owner || '-'}</td><td style="color: ${p.status === 'claimed' ? 'var(--success)' : 'var(--warning)'}">${p.status}</td></tr>`;
                                    });
                                    document.getElementById('member-list').innerHTML = listHtml || '<tr><td colspan="3" style="text-align: center; opacity: 0.5;">No plots assigned yet</td></tr>';

                                    let selectHtml = '<option value="">Select Plot</option>';
                                    for (let i = 1; i <= plots; i++) {
                                                        const plotKey = `${currentFaction}-${currentSubdivision}-${i}`;
                                                        if (!plotsData[plotKey]) {
                                                                                selectHtml += `<option value="${i}">Plot #${i}</option>`;
                                                        }
                                    }
                                    document.getElementById('request-plot').innerHTML = selectHtml;
                    }

                    function renderAdminView() {
                                    const subdivision = getSubdivision(currentSubdivision);
                                    if (!subdivision) return;
                                    const plotsData = getPlots();
                                    const plots = subdivision.plots || 55;

                                    let pendingHtml = '';
                                    Object.entries(plotsData).filter(([key, p]) => key.startsWith(`${currentFaction}-${currentSubdivision}-`) && p.status === 'pending').forEach(([key, p]) => {
                                                        const plotNum = key.split('-')[2];
                                                        pendingHtml += `<div class="pending-item"><span><strong>${p.owner}</strong> requested Plot #${plotNum}</span><div class="pending-actions"><button class="btn-approve" onclick="approvePlot('${key}')">Approve</button><button class="btn-deny" onclick="denyPlot('${key}')">Deny</button></div></div>`;
                                    });
                                    document.getElementById('pending-list').innerHTML = pendingHtml || '<p style="opacity: 0.5;">No pending requests</p>';

                                    let assignHtml = '<option value="">Select Plot</option>';
                                    let removeHtml = '<option value="">Select Plot</option>';
                                    for (let i = 1; i <= plots; i++) {
                                                        const plotKey = `${currentFaction}-${currentSubdivision}-${i}`;
                                                        const plot = plotsData[plotKey];
                                                        if (!plot || plot.status !== 'claimed') {
                                                                                assignHtml += `<option value="${i}">Plot #${i}</option>`;
                                                        }
                                                        if (plot && plot.status === 'claimed') {
                                                                                removeHtml += `<option value="${plotKey}">Plot #${i} - ${plot.owner}</option>`;
                                                        }
                                    }
                                    document.getElementById('assign-plot').innerHTML = assignHtml;
                                    document.getElementById('remove-plot').innerHTML = removeHtml;
                    }

                    function renderAll() {
                                    renderSubdivisionTabs();
                                    if (isAdmin && document.getElementById('admin-view').classList.contains('active')) {
                                                        renderAdminView();
                                    } else {
                                                        renderPublicView();
                                    }
                    }

                    async function submitRequest() {
                                    const name = document.getElementById('request-name').value.trim();
                                    const plotNum = document.getElementById('request-plot').value;
                                    if (!name || !plotNum) { showToast('Please enter name and select plot', 'error'); return; }
                                    const plotKey = `${currentFaction}-${currentSubdivision}-${plotNum}`;
                                    if (!appData[currentFaction].plots) appData[currentFaction].plots = {};
                                    appData[currentFaction].plots[plotKey] = { owner: name, status: 'pending', subdivisionId: currentSubdivision };
                                    await saveData();
                                    renderAll();
                                    showToast('Request submitted!', 'success');
                                    document.getElementById('request-name').value = '';
                    }

                    async function quickAssign() {
                                    const name = document.getElementById('assign-name').value.trim();
                                    const plotNum = document.getElementById('assign-plot').value;
                                    if (!name || !plotNum) { showToast('Please enter name and select plot', 'error'); return; }
                                    const plotKey = `${currentFaction}-${currentSubdivision}-${plotNum}`;
                                    if (!appData[currentFaction].plots) appData[currentFaction].plots = {};
                                    appData[currentFaction].plots[plotKey] = { owner: name, status: 'claimed', subdivisionId: currentSubdivision };
                                    await saveData();
                                    renderAll();
                                    showToast(`Plot #${plotNum} assigned to ${name}`, 'success');
                                    document.getElementById('assign-name').value = '';
                    }

                    async function approvePlot(key) {
                                    if (appData[currentFaction].plots[key]) {
                                                        appData[currentFaction].plots[key].status = 'claimed';
                                                        await saveData();
                                                        renderAll();
                                                        showToast('Request approved!', 'success');
                                    }
                    }

                    async function denyPlot(key) {
                                    delete appData[currentFaction].plots[key];
                                    await saveData();
                                    renderAll();
                                    showToast('Request denied', 'success');
                    }

                    async function removePlot() {
                                    const plotKey = document.getElementById('remove-plot').value;
                                    if (!plotKey) { showToast('Select a plot to remove', 'error'); return; }
                                    delete appData[currentFaction].plots[plotKey];
                                    await saveData();
                                    renderAll();
                                    showToast('Plot assignment removed', 'success');
                    }

                    async function addSubdivision() {
                                    const name = document.getElementById('new-subdivision-name').value.trim();
                                    const plots = parseInt(document.getElementById('new-subdivision-plots').value) || 55;
                                    if (!name) { showToast('Enter subdivision name', 'error'); return; }
                                    const newId = Math.max(...appData[currentFaction].subdivisions.map(s => s.id), 0) + 1;
                                    appData[currentFaction].subdivisions.push({ id: newId, name, plots, enabled: true });
                                    await saveData();
                                    renderAll();
                                    showToast(`Added ${name}`, 'success');
                                    document.getElementById('new-subdivision-name').value = '';
                                    document.getElementById('new-subdivision-plots').value = '';
                    }

                    function showToast(message, type) {
                                    const toast = document.createElement('div');
                                    toast.className = `toast ${type}`;
                                    toast.textContent = message;
                                    document.body.appendChild(toast);
                                    setTimeout(() => toast.remove(), 3000);
                    }

                    document.getElementById('login-modal').addEventListener('click', (e) => {
                                    if (e.target.id === 'login-modal') closeLoginModal();
                    });

                    // Initial load
                    loadData();

                    // Auto-refresh data every 30 seconds
                    setInterval(async () => {
                                    if (!isSyncing) {
                                                        await loadData();
                                    }
                    }, 30000);
        </script>
    </body>
</html>html>
        </script></h2></p></th></th></tr></thead></p>
            </main>
            </header>
    </body>
        </style></title>
    </head>
